<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOTOMORTO - Il Gioco</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        input[type="text"], input[type="number"], input[type="password"] {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover:enabled {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .team-list {
            list-style: none;
            padding: 0;
        }
        .team-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .team-item:last-child {
            border-bottom: none;
        }
        .score {
            font-size: 1.2em;
            font-weight: bold;
            color: #e74c3c;
        }
        .admin-panel {
            margin-top: 30px;
            padding: 20px;
            border: 2px dashed #f39c12;
            background-color: #fffaf0;
            border-radius: 6px;
        }
        .admin-panel-content {
            border-top: 1px solid #f39c12;
            padding-top: 15px;
            margin-top: 15px;
        }
        .admin-control-group {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>TOTOMORTO 2024</h1>
        <p>Inserisci i dati della tua squadra e segui la classifica in tempo reale.</p>

        <h2>Iscrivi la tua Squadra</h2>
        <div id="registrationForm">
            <div class="form-group">
                <input type="text" id="teamName" placeholder="Nome della Squadra" required>
            </div>
            <div class="form-group">
                <input type="text" id="capitanoName" placeholder="Nome del Capitano (Punteggio x2)" required>
            </div>
            <div class="form-group">
                <input type="text" id="giocatore2Name" placeholder="Nome Giocatore 2" required>
            </div>
            <div class="form-group">
                <input type="text" id="giocatore3Name" placeholder="Nome Giocatore 3" required>
            </div>
            <button id="addTeamButton" onclick="saveTeam()">Aggiungi Squadra</button>
        </div>

        <h2 style="margin-top: 30px;">Classifica</h2>
        <ul id="teamsList" class="team-list">
            <li>Nessuna squadra iscritta.</li>
        </ul>

        <div class="admin-panel">
            <h3>Pannello di Amministrazione</h3>
            <div class="form-group">
                <input type="password" id="adminPassword" placeholder="Inserisci la password Admin">
                <button onclick="checkAdminPassword()">Accedi</button>
            </div>

            <div id="adminControls" class="admin-panel-content" style="display: none;">
                
                <div class="admin-control-group">
                    <h4>Stato Mercato Squadre</h4>
                    
                    <input type="checkbox" id="toggleRegistrationsClosed" onchange="toggleTeamRegistrationLock(this.checked)">
                    <label for="toggleRegistrationsClosed" style="font-weight: bold;">Blocca Inserimento/Modifica Squadre (Chiudi Mercato)</label>
                    
                    <p id="registrationStatusMessage" style="margin-top: 10px; font-weight: bold;"></p>
                </div>
                
                <div class="admin-control-group">
                    <h4>Gestione Punteggi</h4>
                    <p>Qui puoi aggiornare i punteggi dei singoli giocatori.</p>
                    <button onclick="alert('Funzione di aggiornamento punteggi da implementare.')">Aggiorna Punteggi</button>
                </div>

                <h4 style="margin-top: 20px;">Audit Log</h4>
                <div id="auditLog" style="max-height: 150px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 4px;">
                    </div>

                <button style="background-color: #e74c3c; margin-top: 15px;" onclick="resetAllData()">Cancella Tutti i Dati (Reset)</button>
            </div>
        </div>

    </div>

    <script>
        // ======================================================
        // VARIABILI GLOBALI E CONFIGURAZIONE
        // ======================================================
        const TEAMS_KEY = 'totomorto_teams';
        const LOG_KEY = 'totomorto_audit_log';
        const ADMIN_PASSWORD = 'B4n4n4l4mp0n3'; 
        let teams = [];
        let auditLog = [];

        // ======================================================
        // NUOVE VARIABILI E FUNZIONI PER LA GESTIONE DELLO STATO ISCRIZIONI
        // ======================================================

        let isRegistrationsClosed = false;
        const REGISTRATION_CLOSED_KEY = 'totomorto_registrations_closed';

        // Carica lo stato di chiusura all'avvio
        function loadRegistrationStatus() {
            const closed = localStorage.getItem(REGISTRATION_CLOSED_KEY);
            isRegistrationsClosed = (closed === 'true'); 
            
            updateRegistrationUI(); 
            
            const checkbox = document.getElementById('toggleRegistrationsClosed');
            if (checkbox) {
                checkbox.checked = isRegistrationsClosed;
            }
        }

        // Funzione chiamata dal pannello Admin per cambiare lo stato
        function toggleTeamRegistrationLock(isClosed) {
            isRegistrationsClosed = isClosed;
            localStorage.setItem(REGISTRATION_CLOSED_KEY, isClosed);
            updateRegistrationUI();

            const action = isClosed ? 'CHIUSURA MERCATO SQUADRE' : 'RIAPERTURA MERCATO SQUADRE';
            logAdminAction(action); 

            alert(`Stato Iscrizioni aggiornato: Mercato ${isClosed ? 'CHIUSO' : 'APERTO'}`);
        }

        // Aggiorna l'interfaccia utente in base allo stato
        function updateRegistrationUI() {
            const addButton = document.getElementById('addTeamButton'); 
            const statusMessage = document.getElementById('registrationStatusMessage');

            if (isRegistrationsClosed) {
                if (addButton) {
                    addButton.disabled = true;
                    addButton.title = "Operazione bloccata. Il Mercato è Chiuso dall'Admin.";
                    addButton.textContent = "Aggiungi Squadra (Mercato Chiuso)";
                }
                if (statusMessage) {
                    statusMessage.textContent = "MERCATO CHIUSO: INSERIMENTO E MODIFICA SQUADRE NON CONSENTITI.";
                    statusMessage.style.color = 'red';
                }
            } else {
                if (addButton) {
                    addButton.disabled = false;
                    addButton.title = "Aggiungi una nuova squadra al gioco.";
                    addButton.textContent = "Aggiungi Squadra";
                }
                if (statusMessage) {
                    statusMessage.textContent = "MERCATO APERTO: ISCRIZIONI ATTIVE.";
                    statusMessage.style.color = 'green';
                }
            }
        }
        
        // ======================================================
        // FUNZIONI DI GESTIONE DATI E UI
        // ======================================================

        function loadData() {
            const storedTeams = localStorage.getItem(TEAMS_KEY);
            const storedLog = localStorage.getItem(LOG_KEY);
            
            if (storedTeams) {
                teams = JSON.parse(storedTeams);
            }
            if (storedLog) {
                auditLog = JSON.parse(storedLog);
            }

            renderTeams();
            renderAuditLog();
        }

        function saveData() {
            localStorage.setItem(TEAMS_KEY, JSON.stringify(teams));
            localStorage.setItem(LOG_KEY, JSON.stringify(auditLog));
        }

        function calculateScore(team) {
            // Logica Semplificata: 10 punti per ogni giocatore + 10 punti bonus per il Capitano (x2)
            let score = 0;
            score += team.giocatore1Score || 10; // Capitano base
            score += team.giocatore2Score || 10;
            score += team.giocatore3Score || 10;

            // Applica il bonus Capitano (il punteggio già aggiunto del capitano è raddoppiato)
            score += team.giocatore1Score || 10;

            return score; 
        }

        function renderTeams() {
            const list = document.getElementById('teamsList');
            list.innerHTML = '';
            
            const sortedTeams = [...teams].sort((a, b) => calculateScore(b) - calculateScore(a));

            if (sortedTeams.length === 0) {
                 list.innerHTML = '<li>Nessuna squadra iscritta.</li>';
                 return;
            }

            sortedTeams.forEach(team => {
                const score = calculateScore(team);
                const li = document.createElement('li');
                li.className = 'team-item';
                li.innerHTML = `
                    <div>
                        <strong>${team.name}</strong> (Capitano: ${team.capitanoName})
                        <br><small>${team.giocatore2Name}, ${team.giocatore3Name}</small>
                    </div>
                    <div class="score">${score} Punti</div>
                `;
                list.appendChild(li);
            });
        }

        function saveTeam() {
            // ******* BLOCCO DI CONTROLLO ISCRIZIONI *******
            if (isRegistrationsClosed) {
                alert("Operazione bloccata dall'Admin. Il mercato delle squadre è stato chiuso e non è possibile aggiungere o modificare squadre.");
                return; // BLOCCA l'esecuzione della funzione
            }
            // ******* FINE BLOCCO DI CONTROLLO *******

            const teamName = document.getElementById('teamName').value.trim();
            const capitanoName = document.getElementById('capitanoName').value.trim();
            const giocatore2Name = document.getElementById('giocatore2Name').value.trim();
            const giocatore3Name = document.getElementById('giocatore3Name').value.trim();

            if (!teamName || !capitanoName || !giocatore2Name || !giocatore3Name) {
                alert("Per favore, compila tutti i campi.");
                return;
            }

            const newTeam = {
                id: Date.now(), 
                name: teamName,
                capitanoName: capitanoName,
                giocatore2Name: giocatore2Name,
                giocatore3Name: giocatore3Name,
                giocatore1Score: 0, 
                giocatore2Score: 0,
                giocatore3Score: 0
            };

            teams.push(newTeam);
            saveData();
            renderTeams();
            logUserAction(`Iscrizione squadra: ${teamName}`);

            document.getElementById('teamName').value = '';
            document.getElementById('capitanoName').value = '';
            document.getElementById('giocatore2Name').value = '';
            document.getElementById('giocatore3Name').value = '';
            
            alert(`Squadra "${teamName}" iscritta con successo!`);
        }
        
        // ======================================================
        // FUNZIONI ADMIN E LOG
        // ======================================================

        function checkAdminPassword() {
            const inputPass = document.getElementById('adminPassword').value;
            if (inputPass === ADMIN_PASSWORD) {
                document.getElementById('adminControls').style.display = 'block';
                document.getElementById('adminPassword').disabled = true;
                alert("Accesso Admin riuscito!");
                logAdminAction("Accesso al Pannello Admin.");
            } else {
                alert("Password Admin errata.");
                document.getElementById('adminPassword').value = '';
            }
        }

        function resetAllData() {
            if (confirm("ATTENZIONE: Sei sicuro di voler cancellare TUTTI i dati (squadre e log)? Questa azione è irreversibile.")) {
                localStorage.removeItem(TEAMS_KEY);
                localStorage.removeItem(LOG_KEY);
                localStorage.removeItem(REGISTRATION_CLOSED_KEY);
                
                teams = [];
                auditLog = [];
                isRegistrationsClosed = false;

                renderTeams();
                renderAuditLog();
                updateRegistrationUI(); 

                alert("Tutti i dati sono stati cancellati. Il gioco è stato resettato.");
            }
        }

        function logAction(action, type) {
            const timestamp = new Date().toLocaleString();
            auditLog.unshift({ timestamp, action, type }); 
            auditLog = auditLog.slice(0, 50); 
            saveData();
            renderAuditLog();
        }

        function logUserAction(action) {
            logAction(action, 'USER');
        }

        function logAdminAction(action) {
            logAction(action, 'ADMIN');
        }

        function renderAuditLog() {
            const logDiv = document.getElementById('auditLog');
            logDiv.innerHTML = auditLog.map(entry => {
                const color = entry.type === 'ADMIN' ? 'color: red;' : 'color: blue;';
                return `<p style="margin: 3px 0; font-size: 0.8em; ${color}">[${entry.timestamp}] (${entry.type}) ${entry.action}</p>`;
            }).join('');
        }


        // ======================================================
        // INIZIALIZZAZIONE
        // ======================================================

        window.onload = function() {
            loadRegistrationStatus(); 
            loadData(); 
        };

    </script>
</body>
</html>
